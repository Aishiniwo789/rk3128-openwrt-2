name: RK3128-OpenWrt-Printer-Server
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 启用ccache缓存
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-rk3128-armv7-ultimate
          restore-keys: ${{ runner.os }}-rk3128-armv7-ultimate

      - name: 安装依赖
        run: sudo apt-get update && sudo apt-get -y install build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch python3 unzip zlib1g-dev lib32gcc-s1 libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler g++-multilib antlr3 gperf wget curl swig rsync ccache

      - name: 【核心】彻底删除旧源码目录（避免残留）
        run: rm -rf openwrt

      - name: 克隆OpenWrt 21.02源码
        run: git clone -b openwrt-21.02 --depth=1 --single-branch https://github.com/openwrt/openwrt.git openwrt

      - name: 复制配置文件
        run: cp .config openwrt/.config

      - name: 验证原始配置
        run: cd openwrt && if grep -q "CONFIG_TARGET_rockchip_armv8" .config; then echo "架构错误：存在armv8配置" && exit 1; else echo "✅ 原始配置验证通过"; fi

      - name: 更新feeds
        run: cd openwrt && ./scripts/feeds update -a && ./scripts/feeds install -a

      - name: 强制清理所有缓存
        run: cd openwrt && make distclean

      - name: 【核心】强制指定armv7目标生成配置
        run: cd openwrt && echo "CONFIG_TARGET_rockchip_armv7_DEVICE_generic=y" > .config && make defconfig

      - name: 验证构建目录
        run: cd openwrt && if [ ! -d "build_dir/target-arm_cortex-a7_neon-vfpv4_musl" ]; then echo "构建目录错误：不是armv7" && exit 1; else echo "✅ 构建目录验证通过：armv7"; fi

      - name: 预下载依赖
        run: cd openwrt && make download -j$(nproc)

      - name: 编译固件
        run: cd openwrt && export CCACHE_DIR=/github/home/.ccache && export PATH=/usr/lib/ccache:$PATH && make -j$(nproc) || make -j1 V=s

      - name: 上传固件
        uses: actions/upload-artifact@v4
        with:
          name: RK3128-OpenWrt-Printer-Firmware
          path: openwrt/bin/targets/rockchip/armv7/*
          retention-days: 30
