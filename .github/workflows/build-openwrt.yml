name: RK3128 OpenWrt 打印服务器 - 最终编译
on:
  workflow_dispatch: # 仅手动触发
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 150 # 留足编译时间
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 全局环境（非交互+终端+架构锁死，核心！）
        run: echo "TERM=xterm" >> $GITHUB_ENV && echo "NCURSES_NO_UTF8_ACS=1" >> $GITHUB_ENV && echo "MCONF_NO_DIRECT=1" >> $GITHUB_ENV && echo "CONFIG_TARGET=rockchip" >> $GITHUB_ENV && echo "CONFIG_TARGET_SUBTARGET=armv7" >> $GITHUB_ENV

      - name: 安装最简依赖
        run: sudo apt update && sudo apt install -y build-essential git libncurses5-dev libncursesw5-dev libz-dev patch python3 unzip zlib1g-dev lib32gcc-s1 libc6-dev-i386 subversion flex gcc-multilib g++-multilib wget curl device-tree-compiler rsync

      - name: 克隆源码
        run: git clone -b openwrt-21.02 --depth=1 https://github.com/openwrt/openwrt.git openwrt

      - name: 清理默认配置
        run: cd openwrt && rm -f .config .config.old

      - name: 更feeds+复制配置+强制非交互下载依赖（合并步骤，减少mconf触发）
        run: cd openwrt && export MCONF_NO_DIRECT=1 NCURSES_NO_UTF8_ACS=1 TERM=xterm && ./scripts/feeds update -a && ./scripts/feeds install -a && cp ../.config .config && make download -j$(nproc) CONFIG_TARGET=rockchip CONFIG_TARGET_SUBTARGET=armv7

      - name: 终极编译（强制非交互+忽略警告+锁死架构，必进实际编译）
        run: cd openwrt && export MCONF_NO_DIRECT=1 NCURSES_NO_UTF8_ACS=1 TERM=xterm && make -j$(nproc) CONFIG_TARGET=rockchip CONFIG_TARGET_SUBTARGET=armv7 CONFIG_TARGET_PROFILE=DEVICE_generic IGNORE_ERRORS=1 || make -j1 V=s CONFIG_TARGET=rockchip CONFIG_TARGET_SUBTARGET=armv7 CONFIG_TARGET_PROFILE=DEVICE_generic IGNORE_ERRORS=1

      - name: 上传固件
        uses: actions/upload-artifact@v4
        with:
          name: RK3128-OpenWrt-Printer-Server
          path: openwrt/bin/targets/rockchip/armv7/*.img*
