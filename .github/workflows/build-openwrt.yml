name: RK3128 OpenWrt 打印服务器 - 极简编译
on:
  workflow_dispatch:  # 仅手动触发，无任何自动干扰
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 150  # 留足时间，避免超时
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 全局终端环境（根治所有终端相关问题）
        run: echo "TERM=xterm" >> $GITHUB_ENV && echo "NCURSES_NO_UTF8_ACS=1" >> $GITHUB_ENV

      - name: 安装编译依赖（RK3128必备，无冗余）
        run: sudo apt update && sudo apt install -y build-essential git libncurses5-dev libz-dev patch python3 unzip zlib1g-dev lib32gcc-s1 libc6-dev-i386 subversion flex gcc-multilib g++-multilib wget curl device-tree-compiler rsync

      - name: 克隆OpenWrt 21.02源码
        run: git clone -b openwrt-21.02 --depth=1 https://github.com/openwrt/openwrt.git openwrt

      - name: 【0.1秒清理】仅删除源码默认配置（无其他耗时操作）
        run: cd openwrt && rm -f .config .config.old

      - name: 先更feeds再复制配置（遵循官方顺序，仅保留核心）
        run: cd openwrt && ./scripts/feeds update -a && ./scripts/feeds install -a && cp ../.config .config

      - name: 预下载依赖（避免编译中下载超时，提速）
        run: cd openwrt && make download -j$(nproc)

      - name: 暴力编译（核心！命令行锁死架构+忽略警告+彻底跳过menuconfig）
        run: cd openwrt && export NCURSES_NO_UTF8_ACS=1 && make -j$(nproc) CONFIG_TARGET=rockchip CONFIG_TARGET_SUBTARGET=armv7 CONFIG_TARGET_PROFILE=DEVICE_generic IGNORE_ERRORS=1 || make -j1 V=s CONFIG_TARGET=rockchip CONFIG_TARGET_SUBTARGET=armv7 CONFIG_TARGET_PROFILE=DEVICE_generic IGNORE_ERRORS=1

      - name: 上传固件（仅保留可刷入的img文件）
        uses: actions/upload-artifact@v4
        with:
          name: RK3128-OpenWrt-Printer-Server
          path: openwrt/bin/targets/rockchip/armv7/*.img*
