name: RK3128 OpenWrt 打印服务器最终编译
on:
  workflow_dispatch:  # 仅保留手动触发，杜绝任何自动干扰
jobs:
  build-rk3128:
    runs-on: ubuntu-22.04
    timeout-minutes: 120  # 2小时超时，足够编译完成
    steps:
      - name: 1. 检出仓库代码（仅含.config）
        uses: actions/checkout@v4

      - name: 2. 全局设置TERM环境变量（所有子进程继承，解决终端问题）
        run: echo "TERM=xterm" >> $GITHUB_ENV

      - name: 3. 安装RK3128编译完整依赖（无冗余，适配32位）
        run: sudo apt-get update && sudo apt-get -y install build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libncursesw5-dev libz-dev patch python3 unzip zlib1g-dev lib32gcc-s1 libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler g++-multilib antlr3 gperf wget curl swig rsync

      - name: 4. 克隆RK3128适配的OpenWrt 21.02源码（浅克隆提速）
        run: git clone -b openwrt-21.02 --depth=1 https://github.com/openwrt/openwrt.git openwrt

      - name: 5. 轻量清理源码（几秒完成，无耗时）
        run: cd openwrt && rm -f .config .config.old && make clean

      - name: 6. 更新OpenWrt官方feeds（按官方顺序，先更feeds）
        run: cd openwrt && ./scripts/feeds update -a

      - name: 7. 安装所有feeds包（按官方顺序，再装feeds）
        run: cd openwrt && ./scripts/feeds install -a

      - name: 8. 复制RK3128专属配置（核心！feeds后复制，永不被覆盖）
        run: cp .config openwrt/.config && chmod 644 openwrt/.config

      - name: 9. 双重锁定目标系统（强制指定Rockchip，杜绝回滚ATH79）
        run: cd openwrt && make defconfig LANG=C CONFIG_TARGET=rockchip && make olddefconfig

      - name: 10. 预下载所有编译依赖（避免编译中下载超时，提速）
        run: cd openwrt && make download -j$(nproc)

      - name: 11. 编译RK3128固件（多核编译，出错时单线程输出详细日志）
        run: cd openwrt && make -j$(nproc) || make -j1 V=s

      - name: 12. 上传可刷入固件（仅保留img/img.gz，精简体积）
        uses: actions/upload-artifact@v4
        with:
          name: RK3128-OpenWrt-Printer-Server-Final-Version
          path: openwrt/bin/targets/rockchip/armv7/*.img*
